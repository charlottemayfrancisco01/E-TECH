<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>4 Pics 1 Word</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  background: #0e1a2b;
  font-family: Arial, sans-serif;
  overflow-x: hidden;
}

/* tech bg */
.tech-bg {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 0;
  pointer-events: none;
}

.tech-dot {
  position: absolute;
  color: rgba(255,255,255,0.2);
  animation: floatTech linear infinite;
}

@keyframes floatTech {
  0% { transform: translateY(0); opacity:0 }
  50% { opacity:.5 }
  100% { transform: translateY(-110vh); opacity:0 }
}

/* links */
.topLink {
  position: fixed;
  left: 15px;
  z-index: 10;
  padding: 10px 16px;
  background: #6a5acd;
  color: white;
  text-decoration: none;
  border-radius: 14px;
  font-weight: bold;
}
.topLink:nth-child(1){ top:15px }
.topLink:nth-child(2){ top:60px }

/* game */
.game-container {
  background: #13294b;
  width: 420px;
  max-width: 95%;
  padding: 24px 20px 36px;
  border-radius: 18px;
  color: #fff;
  text-align: center;
  margin: 70px auto 50px;
}

.images-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}
.images-container img {
  width:100%;
  height:120px;
  object-fit:cover;
  border-radius:10px;
  background: #000; /* Placeholder color if image missing */
}

.answer-container {
  display:flex;
  justify-content:center;
  margin:15px 0;
  gap: 4px; /* Added gap for better spacing */
}

.answer-box {
  width:42px;
  height:42px;
  background:#000;
  border:2px solid #1f3b73;
  font-size:20px;
  font-weight:bold;
  line-height:42px;
  cursor: pointer; /* Show pointer on clickable boxes */
  user-select: none;
}

.letters-container {
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:10px;
}

.letter-tile {
  width:48px;
  height:48px;
  background:#fff;
  color:#000;
  font-size:20px;
  font-weight:bold;
  line-height:48px;
  border-radius:8px;
  cursor: pointer;
  user-select: none;
  box-shadow: 0 4px 0 #ccc; /* Added 3D effect */
}

.letter-tile:active {
    transform: translateY(2px);
    box-shadow: 0 2px 0 #ccc;
}

button {
  margin-top:12px;
  padding:8px 20px;
  border:none;
  border-radius:6px;
  background:#1f6fff;
  color:#fff;
  font-size:16px;
  cursor:pointer;
}

button:disabled {
    background: #555;
    cursor: not-allowed;
}

.skip-btn {
    background: #e74c3c;
    margin-left: 10px;
}
.skip-btn:hover {
    background: #c0392b;
}

.end-screen {
  display:none;
  text-align:center;
  color:white;
  margin-top:120px;
}
.end-buttons {
  margin-top:20px;
  display:flex;
  justify-content:center;
  gap:15px;
}

.score-text {
    font-size: 24px;
    color: #fbbf24;
    margin: 10px 0 20px;
    font-weight: bold;
}
</style>
</head>

<body>

<div class="tech-bg"></div>

<!-- Top-left links -->
<div class="side-links">
  <a href="activities.html" class="topLink">Activities</a>
  <a href="story.html" class="topLink">story</a>
</div>

<!-- GAME -->
<div class="game-container" id="gameContainer">
  <h1>4 Pics 1 Word</h1>
  <p>Tingnan ang apat na larawan at buuin ang salita.</p>

  <div class="images-container">
    <img id="img1"><img id="img2"><img id="img3"><img id="img4">
  </div>

  <div id="answer" class="answer-container"></div>
  <div id="letters" class="letters-container"></div>
  <div id="feedback" style="height: 24px; margin-top: 10px; font-weight: bold;"></div>
  
  <div>
      <button id="nextBtn" disabled>Next</button>
      <button id="skipBtn" class="skip-btn">Skip</button>
  </div>
</div>

<!-- END SET 1 -->
<div id="set1End" class="end-screen">
  <h1>üéâ SET 1 COMPLETE</h1>
  <div id="scoreDisplay1" class="score-text">Score: 0/5</div>
  <div class="end-buttons">
    <button id="playSet1Again">Play Set 1 Again</button>
    <button id="startSet2">Start Set 2</button>
  </div>
</div>

<!-- END SET 2 -->
<div id="set2End" class="end-screen">
  <h1>üèÜ SET 2 COMPLETE</h1>
  <div id="scoreDisplay2" class="score-text">Score: 0/5</div>
  <div class="end-buttons">
    <button id="playSet2Again">Play Set 2 Again</button>
  </div>
</div>

<script>
/* =========================================
    SOUND ENGINE (Web Audio API)
   ========================================= */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playSound(type) {
    if (audioCtx.state === 'suspended') {
        audioCtx.resume();
    }

    const now = audioCtx.currentTime;

    if (type === 'pop') {
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        osc.type = 'triangle';
        osc.frequency.setValueAtTime(300, now);
        osc.frequency.exponentialRampToValueAtTime(50, now + 0.1);
        
        gainNode.gain.setValueAtTime(0.15, now);
        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);

        osc.start(now);
        osc.stop(now + 0.1);

    } else if (type === 'success') {
        // NEW LIVELY "SPARKLE" EFFECT for Correct Answers
        const frequencies = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
        frequencies.forEach((f, i) => {
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            osc.type = 'sine';
            const startTime = now + (i * 0.05);
            osc.frequency.setValueAtTime(f, startTime);
            
            gainNode.gain.setValueAtTime(0.1, startTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.15);

            osc.start(startTime);
            osc.stop(startTime + 0.15);
        });

    } else if (type === 'win') {
        playNote(523.25, now, 0.1); // C5
        playNote(659.25, now + 0.1, 0.1); // E5
        playNote(783.99, now + 0.2, 0.4); // G5

    } else if (type === 'error') {
        const playWonk = (startTime, freq) => {
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            osc.type = 'square'; 
            osc.frequency.setValueAtTime(freq, startTime);
            osc.frequency.exponentialRampToValueAtTime(freq / 2.5, startTime + 0.2);

            gainNode.gain.setValueAtTime(0.08, startTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.2);

            osc.start(startTime);
            osc.stop(startTime + 0.2);
        };

        playWonk(now, 220); 
        playWonk(now + 0.2, 180);
    }
}

function playNote(freq, time, duration) {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    
    osc.type = 'sine';
    osc.frequency.value = freq;
    
    gain.gain.setValueAtTime(0.1, time);
    gain.gain.exponentialRampToValueAtTime(0.01, time + duration);
    
    osc.start(time);
    osc.stop(time + duration);
}

/* tech dots */
function createTechDot(){
  const bg=document.querySelector(".tech-bg");
  const d=document.createElement("div");
  d.className="tech-dot";
  d.textContent="üíª";
  d.style.left=Math.random()*innerWidth+"px";
  d.style.top=innerHeight+"px";
  d.style.animationDuration=5+Math.random()*10+"s";
  bg.appendChild(d);
  setTimeout(()=>d.remove(),12000);
}
setInterval(createTechDot,500);

/* puzzles */
const puzzles=[
{images:["611.jpg","612.jpg","613.jpg","614.jpg"],answer:"SPREADSHEET",revealed:[0,2,6,7]},
{images:["621.jpg","622.jpg","623.jpg","624.jpg"],answer:"CELL",revealed:[0,2]},
{images:["631.jpg","632.jpg","633.jpg","634.jpg"],answer:"FORMULA",revealed:[0,3,5]},
{images:["641.jpg","642.jpg","643.jpg","644.jpg"],answer:"CHARTS",revealed:[0,3]},
{images:["651.jpg","652.jpg","653.jpg","654.jpg"],answer:"DATA",revealed:[0,2]},
  {images:["table1image.jpg","table2image.jpg","table3image.jpg","table4image.jpg"],answer:"TABLE",revealed:[0,3]},
{images:["rows1image.jpg","rows2image.jpg","rows3image.jpg","rows4image.jpg"],answer:"ROWS",revealed:[0,2]},
{images:["column1image.jpg","column2image.jpg","column3image.jpg","column4image.jpg"],answer:"COLUMN",revealed:[0,3,5]},
{images:["list1image.jpg","list2image.jpg","list3image.jpg","list4image.jpg"],answer:"LIST",revealed:[0,2]},
{images:["graph1image.jpg","graph2image.jpg","graph3image.jpg","graph4image.jpg"],answer:"GRAPH",revealed:[0,2]}
];

let current=0;
let userAnswer=[];
let score = 0;
let puzzleCorrect = false;
const SET1_END=5;

const imgs=[img1,img2,img3,img4];
const answerBox=answer;
const lettersBox=letters;
const feedback=document.getElementById("feedback");
const nextBtn=document.getElementById("nextBtn");
const skipBtn=document.getElementById("skipBtn");
const gameContainer = document.getElementById("gameContainer");
const set1End = document.getElementById("set1End");
const set2End = document.getElementById("set2End");
const playSet1Again = document.getElementById("playSet1Again");
const startSet2 = document.getElementById("startSet2");
const playSet2Again = document.getElementById("playSet2Again");


function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
}

function loadPuzzle(){
  feedback.textContent="";
  nextBtn.disabled=true;
  skipBtn.disabled=false;
  answerBox.innerHTML="";
  lettersBox.innerHTML="";
  userAnswer=[];
  puzzleCorrect = false;
  
  // Re-enable interactions in case they were disabled by skip
  answerBox.style.pointerEvents = "auto";
  lettersBox.style.pointerEvents = "auto";

  const p=puzzles[current];
  imgs.forEach((img,i)=>img.src=p.images[i]);
  // Fallback for broken images just in case
  imgs.forEach(img => img.onerror = function() { this.style.display='none'; });


  // 1. CREATE ANSWER BOXES
  p.answer.split("").forEach((letter, i) => {
    const box = document.createElement("div");
    box.className = "answer-box";

    if(p.revealed.includes(i)){
        box.textContent = letter;
        userAnswer[i] = letter;
        box.style.backgroundColor = "#1f3b73"; // Visually distinguish pre-filled
    } else {
        userAnswer[i] = "";
    }

    // CLICK ANSWER BOX TO RETURN LETTER
    box.onclick = () => {
        if(p.revealed.includes(i)) return; // Locked hints
        
        playSound('pop'); // Play sound on return

        // This is the part that was broken before:
        const tileIndex = box.dataset.tile; 
        
        if(tileIndex !== undefined) {
            // Make the letter visible again in the bottom pool
            if(lettersBox.children[tileIndex]) {
                lettersBox.children[tileIndex].style.visibility = "visible";
            }
        }
        
        box.textContent = "";
        userAnswer[i] = "";
        delete box.dataset.tile; // Clear the data
        feedback.textContent = ""; // Clear success/fail message
        nextBtn.disabled = true;
        skipBtn.disabled = false; // Can still skip if not correct
    };

    answerBox.appendChild(box);
  });

  // 2. PREPARE LETTERS POOL
  let letterPool = p.answer.split("");
  // Fill with random letters until we have enough (answer length + 4 randoms)
  while(letterPool.length < p.answer.length + 4){
    letterPool.push(String.fromCharCode(65+Math.random()*26));
  }
  shuffle(letterPool);

  // 3. CREATE LETTER TILES
  // We add 'index' here to track which tile is which
  letterPool.forEach((l, index) => {
    const t = document.createElement("div");
    t.className = "letter-tile";
    t.textContent = l;
    
    t.onclick = () => {
      playSound('pop'); // Play sound on select
      
      const i = userAnswer.indexOf(""); // Find first empty slot
      if(i === -1) return; // No space left

      userAnswer[i] = l;
      answerBox.children[i].textContent = l;
      
      // CRITICAL FIX: Save the index of this tile into the answer box
      // so we know which one to show again if the user cancels.
      answerBox.children[i].dataset.tile = index;
      
      t.style.visibility = "hidden";
      
      if(!userAnswer.includes("")) checkAnswer();
    };
    lettersBox.appendChild(t);
  });
}

function checkAnswer(){
  if(userAnswer.join("") === puzzles[current].answer){
    playSound('success'); // Play success sound
    feedback.textContent = "Correct!";
    feedback.style.color = "#4ade80"; // brighter green
    nextBtn.disabled = false;
    skipBtn.disabled = true; // Cannot skip if you already won
    puzzleCorrect = true;
  } else {
    playSound('error'); // Play error sound
    feedback.textContent = "Wrong!";
    feedback.style.color = "#ef4444"; // brighter red
    nextBtn.disabled = true;
    skipBtn.disabled = false;
    puzzleCorrect = false;
  }
}

skipBtn.onclick = () => {
    playSound('error'); // Play fail/reveal sound
    const p = puzzles[current];
    feedback.textContent = "Skipped! The answer was " + p.answer;
    feedback.style.color = "#e74c3c";
    
    // Fill the boxes visually so they see the answer
    answerBox.innerHTML = '';
    p.answer.split("").forEach(l => {
        const box = document.createElement("div");
        box.className = "answer-box";
        box.textContent = l;
        box.style.color = "#e74c3c";
        box.style.borderColor = "#e74c3c";
        answerBox.appendChild(box);
    });
    
    // Disable interaction so they don't mess up the skipped state
    answerBox.style.pointerEvents = "none";
    lettersBox.style.pointerEvents = "none";

    puzzleCorrect = false; // No points for skipping
    nextBtn.disabled = false;
    skipBtn.disabled = true;
};

nextBtn.onclick=()=>{
  if(puzzleCorrect) {
      score++;
  }

  current++;

  if(current===SET1_END){
    playSound('win'); // Play set win sound
    gameContainer.style.display="none";
    set1End.style.display="block";
    document.getElementById("scoreDisplay1").textContent = "Score: " + score + " / 5";
    return;
  }

  if(current===puzzles.length){
    playSound('win'); // Play set win sound
    gameContainer.style.display="none";
    set2End.style.display="block";
    document.getElementById("scoreDisplay2").textContent = "Score: " + score + " / 5";
    return;
  }

  loadPuzzle();
};

/* PLAY AGAIN */
playSet1Again.onclick=()=>{
  current=0;
  score=0; // Reset score
  set1End.style.display="none";
  gameContainer.style.display="block";
  loadPuzzle();
};

startSet2.onclick=()=>{
  score=0; // Reset score for new set
  set1End.style.display="none";
  gameContainer.style.display="block";
  // current is already at SET1_END (5), so just load
  loadPuzzle();
};

playSet2Again.onclick=()=>{
  current=SET1_END;
  score=0; // Reset score
  set2End.style.display="none";
  gameContainer.style.display="block";
  loadPuzzle();
};

loadPuzzle();
</script>

</body>
</html>
